#include <WiFi.h>
#include <HTTPClient.h>
#include <Update.h>
#include <Adafruit_NeoPixel.h>
#include <WiFiManager.h>
#include <Preferences.h>

// ===================== NeoPixel =====================
constexpr uint8_t PIN_NEO_PIXEL = 21;
constexpr uint8_t NUM_PIXELS    = 1;

Adafruit_NeoPixel neoPixel(NUM_PIXELS, PIN_NEO_PIXEL, NEO_GRB + NEO_KHZ800);

// ===================== Firmware =====================
constexpr char FIRMWARE_URL[] = "https://github.com/reneilletschko/race-frame/releases/download/updates/firmware.bin";
constexpr char VERSION_URL[]  = "https://raw.githubusercontent.com/reneilletschko/race-frame/refs/heads/main/Firmware/version.txt";
constexpr char CURRENT_FIRMWARE_VERSION[] = "1.6";

// ===================== Timing =====================
constexpr unsigned long UPDATE_CHECK_INTERVAL_MS = 5 * 60 * 1000;
constexpr uint16_t LED_BLINK_MS = 250;
constexpr uint16_t RESET_WINDOW_MS = 4000;

// ===================== Globals =====================
WiFiManager g_wifiManager;
Preferences g_prefs;

unsigned long g_lastUpdateCheck = 0;

// ===================== LED Helpers =====================
void setLedColor(uint8_t r, uint8_t g, uint8_t b) {
  neoPixel.setPixelColor(0, neoPixel.Color(r, g, b));
  neoPixel.show();
}

void blinkLed(uint8_t r, uint8_t g, uint8_t b, uint16_t delayMs = LED_BLINK_MS) {
  setLedColor(r, g, b);
  delay(delayMs);
  setLedColor(0, 0, 0);
  delay(delayMs);
}

// ===================== Factory Reset =====================
void handleFactoryReset() {
  g_prefs.begin("boot", false);

  int bootCount = g_prefs.getInt("boots", 0);
  bootCount++;
  g_prefs.putInt("boots", bootCount);

  if (bootCount >= 3) {
    for (int i = 0; i < 10; i++) blinkLed(255, 0, 0, 100);

    g_prefs.end();

    Preferences clearConfig;
    clearConfig.begin("config", false);
    clearConfig.clear();
    clearConfig.end();

    Preferences clearBoot;
    clearBoot.begin("boot", false);
    clearBoot.clear();
    clearBoot.end();

    ESP.restart();
  }

  delay(RESET_WINDOW_MS);
  g_prefs.putInt("boots", 0);
  g_prefs.end();
}

// ===================== WiFi Setup =====================
void initWifi() {
  g_prefs.begin("config", false);

  String ssid = g_prefs.getString("ssid", "");
  String pass = g_prefs.getString("pass", "");

  if (ssid.isEmpty()) {
    setLedColor(0, 0, 255); // Blau = Captive Portal
    g_wifiManager.autoConnect("RaceFrame-Setup");

    g_prefs.putString("ssid", WiFi.SSID());
    g_prefs.putString("pass", WiFi.psk());

    delay(1000);
    ESP.restart();
  }

  WiFi.begin(ssid.c_str(), pass.c_str());

  while (WiFi.status() != WL_CONNECTED) {
    blinkLed(255, 180, 0); // Gelb = Verbinden
  }

  for (int i = 0; i < 3; i++) blinkLed(0, 255, 0, 150); // Grün = Verbunden

  g_prefs.end();
}

// ===================== OTA =====================
String fetchLatestVersion() {
  HTTPClient http;
  http.begin(VERSION_URL);

  int httpCode = http.GET();
  if (httpCode == HTTP_CODE_OK) {
    String version = http.getString();
    version.trim();
    http.end();
    return version;
  }

  http.end();
  return "";
}

bool startOtaUpdate(WiFiClient* client, int contentLength) {
  if (!Update.begin(contentLength)) return false;

  size_t written = 0;

  while (written < contentLength) {
    if (client->available()) {
      uint8_t buffer[128];
      size_t len = client->read(buffer, sizeof(buffer));
      if (len > 0) {
        Update.write(buffer, len);
        written += len;
        setLedColor(180, 0, 255); // Lila = OTA
      }
    }
    yield();
  }

  return Update.end();
}

void performOtaUpdate() {
  HTTPClient http;
  http.begin(FIRMWARE_URL);

  int httpCode = http.GET();
  if (httpCode == HTTP_CODE_OK) {
    int contentLength = http.getSize();
    if (contentLength > 0) {
      WiFiClient* stream = http.getStreamPtr();
      if (startOtaUpdate(stream, contentLength)) {
        delay(2000);
        ESP.restart();
      }
    }
  }

  http.end();
}

void checkForOtaUpdate() {
  if (WiFi.status() != WL_CONNECTED) return;

  String latestVersion = fetchLatestVersion();
  if (latestVersion.isEmpty()) return;

  if (latestVersion != CURRENT_FIRMWARE_VERSION) {
    performOtaUpdate();
  }
}

// ===================== Setup =====================
void setup() {
  neoPixel.begin();
  Serial.begin(115200);

  handleFactoryReset();
  initWifi();
  checkForOtaUpdate();
}

// ===================== Loop =====================
void loop() {
  if (millis() - g_lastUpdateCheck >= UPDATE_CHECK_INTERVAL_MS) {
    g_lastUpdateCheck = millis();
    checkForOtaUpdate();
  }

  blinkLed(0, 255, 0, 500); // Grün = Normalbetrieb
}
